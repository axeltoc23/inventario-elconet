{% extends "productos/base.html" %}

{% block title %}Historial de Movimientos{% endblock %}

{% block content %}
    <h1>📜 Historial de Movimientos</h1>

    <!-- Formulario de búsqueda -->
<form method="GET" action="{% url 'historial_movimientos' %}">
    <input type="text" name="q" placeholder="Buscar por código, producto o comentario" value="{{ query }}">

    <label for="tipo">Tipo de movimiento:</label>
    <select name="tipo" id="tipo">
        <option value="">Todos</option>
        <option value="entrada" {% if request.GET.tipo == "entrada" %}selected{% endif %}>Entradas</option>
        <option value="salida" {% if request.GET.tipo == "salida" %}selected{% endif %}>Salidas</option>
    </select>

    <label for="fecha_filtro">Fecha:</label>
    <input type="text" name="fecha_filtro" placeholder="Ej: >01-04-2024 o 01-04-2024-30-04-2024" value="{{ fecha_filtro }}">

    <button type="submit">🔍 Buscar</button>
</form>

<form method="get" action="{% url 'historial_movimientos' %}">
    <button type="submit">🧹 Limpiar filtros</button>
</form>

<a href="{% url 'exportar_historial_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success">📊 Exportar a Excel</a>
<a href="{% url 'exportar_historial_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger">📄 Exportar a PDF</a>

    <ul>
        {% for movimiento in movimientos %}
            <li>
                📅 {{ movimiento.fecha|date:"d/m/Y H:i" }} -
                {{ movimiento.tipo|title }} de {{ movimiento.cantidad }} -
                🏷️ {{ movimiento.producto.codigo }} - {{ movimiento.nombre_producto }}
                {% if movimiento.comentario %} 📝 ({{ movimiento.comentario }}){% endif %}
                {% if movimiento.usuario %}
                    👤 por <em>{{ movimiento.usuario.get_full_name|default:movimiento.usuario.username }}</em>
                {% else %}
                    👤 por <em>usuario no registrado</em>
                {% endif %}
            </li>
        {% empty %}
            <li>⚠️ No se encontraron movimientos.</li>
        {% endfor %}
    </ul>

    <a href="{% url 'lista_productos' %}">⬅️ Volver</a>

<div class="pagination">
    <span class="step-links">
        {% if movimientos.has_previous %}
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page=1">⏮ Primera</a>
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ movimientos.previous_page_number }}">⬅ Anterior</a>
        {% endif %}

        <span>Página {{ movimientos.number }} de {{ movimientos.paginator.num_pages }}</span>

        {% if movimientos.has_next %}
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ movimientos.next_page_number }}">Siguiente ➡</a>
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ movimientos.paginator.num_pages }}">Última ⏭</a>
        {% endif %}
    </span>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form[action="{% url 'historial_movimientos' %}"]');

        form.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Evita que se abra de nuevo el select
                form.submit(); // Envía el formulario directamente
            }
        });
    });
</script>

{% endblock %}

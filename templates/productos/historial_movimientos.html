{% extends "productos/base.html" %}

{% block title %}Historial de Movimientos{% endblock %}

{% block content %}
    <h1>ğŸ“œ Historial de Movimientos</h1>

    <!-- Formulario de bÃºsqueda -->
<form method="GET" action="{% url 'historial_movimientos' %}">
    <input type="text" name="q" placeholder="Buscar por cÃ³digo, producto o comentario" value="{{ query }}">

    <label for="tipo">Tipo de movimiento:</label>
    <select name="tipo" id="tipo">
        <option value="">Todos</option>
        <option value="entrada" {% if request.GET.tipo == "entrada" %}selected{% endif %}>Entradas</option>
        <option value="salida" {% if request.GET.tipo == "salida" %}selected{% endif %}>Salidas</option>
    </select>

    <label for="fecha_filtro">Fecha:</label>
    <input type="text" name="fecha_filtro" placeholder="Ej: >01-04-2024 o 01-04-2024-30-04-2024" value="{{ fecha_filtro }}">

    <button type="submit">ğŸ” Buscar</button>
</form>

<form method="get" action="{% url 'historial_movimientos' %}">
    <button type="submit">ğŸ§¹ Limpiar filtros</button>
</form>

<a href="{% url 'exportar_historial_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success">ğŸ“Š Exportar a Excel</a>
<a href="{% url 'exportar_historial_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger">ğŸ“„ Exportar a PDF</a>

    <ul>
        {% for movimiento in movimientos %}
            <li>
                ğŸ“… {{ movimiento.fecha|date:"d/m/Y H:i" }} -
                {{ movimiento.tipo|title }} de {{ movimiento.cantidad }} -
                ğŸ·ï¸ {{ movimiento.producto.codigo }} - {{ movimiento.nombre_producto }}
                {% if movimiento.comentario %} ğŸ“ ({{ movimiento.comentario }}){% endif %}
                {% if movimiento.usuario %}
                    ğŸ‘¤ por <em>{{ movimiento.usuario.get_full_name|default:movimiento.usuario.username }}</em>
                {% else %}
                    ğŸ‘¤ por <em>usuario no registrado</em>
                {% endif %}
            </li>
        {% empty %}
            <li>âš ï¸ No se encontraron movimientos.</li>
        {% endfor %}
    </ul>

    <a href="{% url 'lista_productos' %}">â¬…ï¸ Volver</a>

<div class="pagination">
    <span class="step-links">
        {% if movimientos.has_previous %}
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page=1">â® Primera</a>
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ movimientos.previous_page_number }}">â¬… Anterior</a>
        {% endif %}

        <span>PÃ¡gina {{ movimientos.number }} de {{ movimientos.paginator.num_pages }}</span>

        {% if movimientos.has_next %}
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ movimientos.next_page_number }}">Siguiente â¡</a>
            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ movimientos.paginator.num_pages }}">Ãšltima â­</a>
        {% endif %}
    </span>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form[action="{% url 'historial_movimientos' %}"]');

        form.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Evita que se abra de nuevo el select
                form.submit(); // EnvÃ­a el formulario directamente
            }
        });
    });
</script>

{% endblock %}
